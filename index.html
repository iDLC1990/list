<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>LCDR LIVE DATA 2026</title>

<style>
body {
  background: url("https://raw.githubusercontent.com/iDLC1990/test/main/pexels-iriser-1366957.jpg") no-repeat center center fixed;
  background-size: cover;
  color: #fff;
  font-family: Arial, sans-serif;
}

.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px 10%;
  background-color: rgba(0,0,0,0.39);
  flex-wrap: wrap;
}

.header h1 {
  margin: 0;
  color: #00cccc;
  font-size: 24px;
}

.controls {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-top: 10px;
  flex-wrap: wrap;
}

.date-info { color: #00cccc; font-size: 18px; }

input[type="date"] {
  padding: 6px 10px;
  font-size: 16px;
  border-radius: 5px;
  border: none;
}

#auto-timer {
  color:#00ffea;
  font-size:16px;
  font-weight:bold;
  margin-left:10px;
}

#stats-container {
  width: 95%;
  margin: 24px auto;
  overflow-x: auto;
}

table {
  width: 100%;
  border-collapse: collapse;
  background-color: rgba(0,0,0,0.8);
  color: #fff;
}

th, td {
  border: 1px solid #555;
  padding: 8px 10px;
  text-align: center;
  font-size: 14px;
}

th {
  background-color: #00415096;
  font-weight: bold;
  position: sticky;
  top: 0;
  z-index: 1;
}

td:first-child {
  background-color: #00415096;
  font-weight: bold;
  text-align: left;
  cursor: pointer;
}

tbody tr:nth-child(even) {
  background-color: rgba(0,0,0,0.6);
}

.detail-row td {
  background-color: rgba(0,128,128,0.2);
  text-align: left;
  font-size: 13px;
}

.detail-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 5px;
}

.detail-table th,
.detail-table td {
  border: 1px solid #555;
  padding: 4px 6px;
  font-size: 13px;
}
</style>
</head>

<body>

<div class="header">
  <h1>LCDR LIVE DATA 2026</h1>
  <div class="controls">
    <label class="date-info">Od:</label>
    <input type="date" id="date-from"/>
    <label class="date-info">Do:</label>
    <input type="date" id="date-to"/>
    <button id="update-btn"
      style="padding:6px 12px; border:none; border-radius:5px; background-color:#005050; color:#fff; cursor:pointer;">
      Aktualizuj
    </button>
    <div id="auto-timer">Auto refresh in: --:--</div>
  </div>
</div>

<div id="stats-container"></div>

<script>
const apiKey = 'AIzaSyCP7tzYiGwIZ6cymLAlv_9QgPIEshnRgqI';
const sheetId = '10W03bvKlVFlIUcxsHkzP_v_13gtnYRBmnrrO0ujB1bU';
const sheetURL = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/`;
const secondSheetId = '1UWu4bcuHg6NHhK8ZvjDlQAIue6R1FLBlmAlBhHBj-D8';
const secondSheetName = '123';

let refreshInterval = 300000;
let countdown = refreshInterval / 1000;
let countdownTimer;

// ================= TIMER =================
function startCountdown(){
  clearInterval(countdownTimer);
  countdown = refreshInterval / 1000;

  countdownTimer = setInterval(()=>{
    countdown--;
    document.getElementById('auto-timer').textContent =
      `Auto refresh in: ${Math.floor(countdown/60)}:${String(countdown%60).padStart(2,'0')}`;
    if(countdown <= 0) update();
  },1000);
}

setInterval(update, refreshInterval);

// ================= API =================
async function fetchMainData(){
  const res = await fetch(`${sheetURL}${encodeURIComponent('FI Station 2 ULANOVYCH.R')}?key=${apiKey}`);
  const data = await res.json();
  const rows = data.values || [];
  return rows.slice(1).map(r=>({
    date: r[0]||'',
    serial: r[2]||'',
    statusE: (r[4]||'').toUpperCase(),
    statusH: r[7]||'',
    matrixStatus: r[9]||'',
    description: r[10]||'',
    person: r[5]||''
  }));
}

async function fetchSecondSheetData(){
  const res = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${secondSheetId}/values/${encodeURIComponent(secondSheetName)}?key=${apiKey}`);
  const data = await res.json();
  const rows = data.values || [];
  const counts = {};

  rows.slice(1).forEach(r=>{
    const serial = r[0];
    const date = r[1]?.split(' ')[0];
    if(!serial || !date) return;
    if(!counts[serial]) counts[serial] = {};
    counts[serial][date] = (counts[serial][date] || 0) + 1;
  });

  return counts;
}

function getChecksCount(serial, from, to, counts){
  if(!counts[serial]) return 0;
  let total = 0;
  for(const d in counts[serial]){
    const cd = new Date(d);
    if(cd >= new Date(from) && cd <= new Date(to)){
      total += counts[serial][d];
    }
  }
  return total;
}

// ================= UPDATE =================
async function update(){
  const dateFromInput = document.getElementById('date-from');
  const dateToInput   = document.getElementById('date-to');

  const from = dateFromInput.value;
  const to   = dateToInput.value;

  if(!from || !to) return;


  const [data, secondCounts] = await Promise.all([
    fetchMainData(),
    fetchSecondSheetData()
  ]);

  const stats = {};

  data.filter(d=>{
    const dd = d.date.split(' ')[0];
    return dd >= from && dd <= to;
  }).forEach(d=>{
    if(!stats[d.person])
      stats[d.person] = {ok:0, ndf:0, waiting:0, scrap:0, details:[]};

    if(d.statusE==='OK') stats[d.person].ok++;
    else if(d.statusE==='NDF') stats[d.person].ndf++;
    else if(d.statusE.includes('WAITING')) stats[d.person].waiting++;
    else if(d.statusE.includes('SCRAP')) stats[d.person].scrap++;

    stats[d.person].details.push(d);
  });

  renderTable(stats, from, to, secondCounts);
  startCountdown();
}

// ================= RENDER =================
function renderTable(stats, from, to, secondCounts){
  const c = document.getElementById('stats-container');
  c.innerHTML = '';

  const table = document.createElement('table');
  table.innerHTML = `
    <thead>
      <tr>
        <th>Name</th><th>OK</th><th>NDF</th><th>Waiting</th><th>Scrap</th><th>Total</th>
      </tr>
    </thead>
  `;

  const tbody = document.createElement('tbody');

  Object.keys(stats).forEach(person=>{
    const tr = document.createElement('tr');
    const s = stats[person];

    tr.innerHTML = `
      <td>${person}</td>
      <td>${s.ok}</td>
      <td>${s.ndf}</td>
      <td>${s.waiting}</td>
      <td>${s.scrap}</td>
      <td>${s.ok + s.ndf}</td>
    `;

    tr.querySelector('td').onclick = () => {
      if(tr.nextSibling?.classList.contains('detail-row')){
        tr.nextSibling.remove(); return;
      }

      const dr = document.createElement('tr');
      dr.className = 'detail-row';
      const td = document.createElement('td');
      td.colSpan = 6;

      const dt = document.createElement('table');
      dt.className = 'detail-table';
      dt.innerHTML = `
        <thead>
          <tr>
            <th></th><th>Serial</th><th>Status</th><th></th><th>NEW / NP</th><th>Description</th>
          </tr>
        </thead>
      `;

      const db = document.createElement('tbody');
      let totalChecks = 0;

      s.details.forEach(d=>{
        const cc = getChecksCount(d.serial, from, to, secondCounts);
        if(cc>0) totalChecks+=cc;

        const r = document.createElement('tr');
        r.innerHTML = `
          <td>${cc||''}</td>
          <td>${d.serial}</td>
          <td>${d.statusE}</td>
          <td>${d.statusH}</td>
          <td>${d.matrixStatus}</td>
          <td>${d.description}</td>
        `;
        db.appendChild(r);
      });

      // ===== TOTAL ROW =====
      const trTotal = document.createElement('tr');
      trTotal.innerHTML = `
        <td style="font-weight:bold;background:rgba(0,150,150,.3)">${totalChecks}</td>
        <td style="font-weight:bold;background:rgba(0,150,150,.3)">TOTAL</td>
        <td></td><td></td><td></td><td></td>
      `;
      db.appendChild(trTotal);

      dt.appendChild(db);
      td.appendChild(dt);
      dr.appendChild(td);
      tr.after(dr);
    };

    tbody.appendChild(tr);
  });

  table.appendChild(tbody);
  c.appendChild(table);
}

document.getElementById('update-btn').addEventListener('click', update);
</script>

</body>
</html>
